function getBaseName(e,d){var f,d=d?d:40;return e&&(f=e.substring(Math.max(e.lastIndexOf("\\"),e.lastIndexOf("/"))+1),f.length>d&&(f=f.substr(0,d-7)+"..."+f.substr(f.length-7,f.length))),f}function getFileIcon(d,c){chrome.downloads.search({id:d},function(b){if(!(b[0]||{}).filename){var a="icons/icons.png";return"function"==typeof c&&c(a),void 0}chrome.downloads.getFileIcon(d,{size:32},function(e){"function"==typeof c&&c(e)})})}function tmplRender(e,d){var f="";return d.forEach(function(z,y){var v,u,t,s,r,q,c,b,a,x=d[y],w=e;for(v in x){if(u=new RegExp("{{"+v+"}}","ig"),t=new RegExp("{{(.*?)\\((.*?"+v+".*?)\\)}}","ig"),s=t.exec(w)||[],r=$.trim(s[1]),q=(s[2]||"").split(",")||[],r&&q&&q.indexOf(v)>-1){for(c=q,b=0,a=c.length;a>b;b++){c[b]==v&&(c[b]=x[v])}w=w.replace(t,window[r].apply(window,c))}else{w=w.replace(u,x[v])}}w=w.replace(/\{\{.*?\}\}/,""),f+=w}),f}function itemRender(j,i,p){var m,l,k,o=$("#"+j),n={".item-title":"name",".item-size":"size",".item-time":"time"};for(m in n){l=i[n[m]],"name"!=n[m]||l||(l=i.url.split("//")[1].split("?")[0]),o.find(m).html(l)}k="item-state",o.find("."+k).attr("class",k+" state-"+i.state),o.attr("id",i.id).attr("state",i.state),o.find(".item-progress-bar i").css("width",i.progress),setFileIcon([i]),0!=p&&handleRerender(o)}function setFileIcon(b){b.forEach(function(d){var e=d.id;getFileIcon(e,function(c){c||(c="icons/icons.png"),$("#"+e).find(".item-icon img").attr("src",c)})})}function formatData(t){var r,q,p,o,n,m,l,k,s=t.state;return"in_progress"==s&&(s=t.paused?"pause":"download"),t.exists||(s="miss"),r=getBaseName(t.filename),q=t.fileSize||t.bytesReceived,p={id:t.id,name:r,_name:r,size:formatBytes(q),time:formatTime(t.startTime),url:t.url,state:s,startTime:t.startTime,progress:(100*t.bytesReceived/(t.totalBytes||q)).toFixed(1)+"%"},"complete"==s?p.name='<a class="handle-open">'+p.name+'</a><i class="handle-show"></i>':"download"==s&&(o=t.estimatedEndTime,n="undefined"!=typeof o?new Date(t.estimatedEndTime).getTime()-(new Date).getTime():8553600000,m=t.totalBytes-t.bytesReceived,l=formatSpeed(n,m),k=formatTimeLeft(n),p.size=formatBytes(t.bytesReceived)+" / "+formatBytes(t.totalBytes)+" - "+l+"   , "+k),p}function pollProgress(f,e){var h,g;window.hasDownloading=!1,h={limit:10,orderBy:["-startTime"]};for(g in f){h[g]=f[g]}chrome.downloads.search(h,function(b){var c,d=[];return b.forEach(function(j){var i=formatData(j);d.push(i),"download"==i.state&&(window.hasDownloading=!0)}),"-startTime"!=h.orderBy[0]&&d.reverse(),hasDownloading&&(h.state="in_progress",h.paused=!1,pollDownloading(h)),"function"==typeof e?(e(d),void 0):(d.length&&(c=tmplRender($("#tmpl-items").html(),d),$("#item-list").html(c),setFileIcon(d),handleFunBind()),void 0)})}function pollDownloading(b){var b=b?b:{state:"in_progress",paused:!1};window.pollInter=setTimeout(function(){pollProgress(b,function(c){c.length||clearInterval(pollInter),c.forEach(function(d){itemRender(d.id,d,!1)})})},200)}function handleRerender(r){var k,j,q=r,p=q.attr("state"),o="",n=q.find(".item-handle"),m={pause:['<span class="handle-start" title="Start"></span>',"handle-start","Start"],download:['<span class="handle-pause" title="Pause"></span>',"handle-pause","Pause"],interrupted:[o+'<span class="handle-restart" title="Restart"></span>',"handle-restart","Restart"]},l=m[p]||[];o=l[0]||"",k=o+'<span class="handle-del" title="Delete"></span>',n.size()?(j=n.find("span"),2==j.size()?j.eq(0).attr("title",l[2]).attr("class",l[1]):n.html(k)):(k='<div class="item-handle">'+k+"</div>",q.append(k))}function handleFunBind(){var b='<i class="handle-copylink" title="'+getLang("copy")+'"></i>';$("#item-list li").off("mouseenter").on("mouseenter",function(){var a=$(this);handleRerender(a),a.addClass("handle-hover"),a.find(".handle-copylink").size()||a.find(".item-url").append(b)}).off("mouseleave").on("mouseleave",function(){$(".item-handle,.handle-copylink").remove(),$(this).removeClass("handle-hover")})}function _checkDanger(){var b={};chrome.downloads.search({state:"in_progress"},function(a){a.forEach(function(d){var e="safe"!=d.danger&&"accepted"!=d.danger;return e?(b=d,!1):void 0}),setTimeout(function(){_acceptDanger(b)},200)})}function _acceptDanger(b){b.id&&chrome.downloads.acceptDanger(b.id,function(){})}function getId(d){var c=$(d);return parseInt(c.closest("li").attr("id"))}function handleEventBind(){$(".handle-start").live("click",function(){ItemFun.resume(getId(this),function(){})}),$(".handle-pause").live("click",function(){chrome.downloads.pause(getId(this),function(){})}),$(".handle-restart").live("click",function(){var b=getId(this);ItemFun.getInfo(b,function(a){var h=a.filename.indexOf("/")>-1?"/":"\\",g=a.filename.split(h),f=g.length;g=g[f-1],options={filename:g,url:a.url},ItemFun.erase({id:b},function(){ItemFun.download(options,function(c){ItemFun.getInfo(c,function(d){var e=formatData(d);itemRender(b,e)})})})})}),$(".handle-del").live("click",function(){var i,h,g=$(this),f=g.closest("li"),j=f.attr("state");g.find(".handle-del-list").size()||("download"==j?ItemFun.cancel(getId(this)):"complete"==j?(i="",$("#footer").offset().top-f.offset().top<112&&(i="position-top"),h='<div class="handle-del-list '+i+'"><div class="del-from-list">'+getLang("from_list")+'</div><div class="del-from-disk">'+getLang("from_disk")+"</div><i></i>",g.parent().append(h)):ItemFun.erase({id:getId(this)},function(){f.remove()}))}),$(".del-from-list").live("click",function(){var b=$(this).closest("li");ItemFun.erase({id:getId(this)},function(){b.remove()})}),$(".del-from-disk").live("click",function(){var b=$(this).closest("li");ItemFun.remove(getId(this),function(){b.remove()})}),$(".handle-open").live("click",function(){ItemFun.open(getId(this))}),$(".handle-show").live("click",function(){ItemFun.show(getId(this))}),$(".handle-copylink").live("click",function(){var b=$(this).closest("li").find(".item-url").text();ItemFun.copylink(b,function(){})}),$("#search-input").bind("keyup input propertychange",function(){var d=$(this),c=d.val();"undefined"!=typeof inter&&clearTimeout(inter),inter=setTimeout(function(){var b={filenameRegex:".*?"+c+".*?"};pollProgress(b)},500)}).on("focus",function(){sentEvent("popupManagerPage","header-tool","Search")}),$(".page-show").live("click",function(){var b=$("#page-list");b.toggleClass("active"),$(".clearup-list,.faq-footer").toggleClass("active"),sentEvent("popupManagerPage","page-show",b.hasClass("active")?"show":"hide")}),$("#page-list li").live("click",function(){var h=$(this),g=h.attr("class"),l=$("#item-list li"),k=l.eq(0).get(0),j=l.eq(l.size()-1).get(0),i="page-prev"==g?k:j;ItemFun.getInfo(getId(i),function(b){var d={};"page-prev"==g?(d.startedAfter=b.startTime,d.orderBy=["startTime"]):"page-next"==g?d.startedBefore=b.startTime:d={},pollProgress(d),this.blur()})}).live("selectstart",function(){return !1}),$(".clearup-list").on("click",function(d){var c=$(this);d.target==c.get(0)&&c.toggleClass("hover")}).on("mouseleave",function(){$(this).removeClass("hover")}),$(".clearup-btn").on("click",function(){var e=$(this),d=e.attr("data"),f={id:0};switch(d){case"all":f={limit:0};break;case"finished":f={state:"complete",limit:0};break;case"failure":f={state:"interrupted",limit:0};break;case"missing":f={exists:!1,limit:0}}return"failure"==d?(ItemFun.search({},function(b){b.forEach(function(c){"interrupted"==c.state&&ItemFun.erase({id:c.id})})}),pollProgress(),void 0):(chrome.downloads.erase(f,function(){$(".clearup-list").removeClass("hover"),pollProgress({},null,!0)}),void 0)})}function init(){$("#footer-hot [i18n]").each(function(){var d=$(this),c=getLang(d.attr("i18n"));d.attr("title",c)}).on("click",function(){sentEvent("popupManagerPage","footer-hot",$(this).attr("data"))})}function mediaCheck(r){var n,m,l,k,j,q=$("#header-media"),p=q.find("span"),o=!1;for(n=0,m=mediaTypes.length;m>n;n++){l=mediaTypes[n],k=$(".media-name b"),(r[l]||[]).length&&(p.eq(n).css("display","inline-block"),o||(o=!0,p.eq(n).addClass("active"),mediaRender(l),"image"==l?k.hide():k.show()))}o||(j=$("#media-list"),j.attr("class","media-empty").html('<div id="reportUrl-btn">Report this URL</div>'),$("#reportUrl-btn").die().bind("click",function(){j.html('<div id="report-success">The URL report success, we will deal with it as soon as possible, thanks! </div>');try{sentEvent("reportMediaURL",TabNow.url,window.navigator.language)}catch(b){}}))}function checkYoutubeUrl(e){for(var d=0,f=e.length;f>d;d++){if(TabNow.url.indexOf("youtube.com")>-1&&e[d].url.indexOf("googlevideo.com")>-1){return !0}}return !1}function mediaRender(f,e){var h=medias[f],g="";checkYoutubeUrl(h)||MediaFilted&&filterTypes.indexOf(f)>-1?($("#media-list").addClass("youtube-filter"),g='<div class="youtube-filter-info"><a target="_blank" href="https://www.youtube.com/static?template=terms">YouTube Terms</a> <font>does not allow</font> downloading videos directly from YouTube</div>'):g=tmplRender($("#tmpl-medias").html(),h),$("#media-list").html(g).removeClass("media-scanning"),"function"==typeof e&&e()}function mediaShow(){chrome.windows.getCurrent(function(b){chrome.tabs.query({active:!0,windowId:b.id},function(d){tab=d[0],TabNow=tab;var c=tab.id;return c?(window.medias=BG.MediaList[c]||{},tab.url.indexOf(".youtube.com")>-1&&(MediaFilted=!0),medias.image=medias.image||[],tab.url.indexOf("chrome://")>-1?(mediaCheck(medias),void 0):(medias.image.length?mediaCheck(medias):sendMessage(c,{type:"getImages",key:KEY},function(e){var e=e||{};e.key==KEY&&e.data&&e.data!=[]&&(medias.image=e.data),mediaCheck(medias)}),void 0)):void 0})})}function mediaDownload(r){var j,q=$(r),p=$(".media-download").index(q),o=$("#header-media .active").index(),n=mediaTypes[o-1],m=medias[n][p]||{},l={url:m.url},k=m.name.length>50?(m.title||m.name.substring(0,20))+"."+m.ext:m.name;k.split(".")[1]&&(l.filename=k),j=q.closest(".media-item"),q.addClass("active"),j.addClass("downloaded"),ItemFun.download(l,function(){medias[n][p]["downloaded"]=!0,q.removeClass("active").addClass("animate"),setTimeout(function(){j.hide()},200)})}function mediaEventInit(){$("#header-media>span").live("click",function(){var g,f=$(this),e=$(this).index(),h=mediaTypes[e-1];$("#media-list").attr("class","media-scanning"),f.siblings().removeClass("active"),f.addClass("active"),mediaRender(h),g=$(".media-name b"),"image"==h?g.hide():g.show()}),$(".button-scan,.media-back").on("click",function(){$("html,body").toggleClass("mode-media");var d=$("body").hasClass("mode-media"),c=$("#batch-down-btn");localStorage.modeMedia=d,d?(mediaShow(),c.removeClass("selected")):(pollProgress(),$("#media-list").html(""),$("#header-media .active").each(function(b){b>0&&$(this).removeClass("active")}))}),$(".media-item").live("click",function(g){var i,h,f=["media-download"],j=g.target.className||"";f.indexOf(j)>-1||($(this).toggleClass("selected"),i=$("#media-list .media-item"),h=$("#batch-down-btn"),0==$("#media-list .selected").size()&&i.size()>0?h.removeClass("selected"):h.addClass("selected"))}),$("#batch-download>input").on("click",function(){var e=$("#media-list .media-item"),d=$(this),f=$("#batch-down-btn");0==$("#media-list .selected").size()&&e.size()>0?(e.add(f).addClass("selected"),d.prop("checked","checked")):(e.add(f).removeClass("selected"),d.prop("checked",!1))}),$("#batch-down-btn").on("click",function(){var b=$("#media-list .selected");b.each(function(){mediaDownload($(this).find(".media-download"))}),b.add($("#batch-down-btn")).removeClass("selected"),$("input[name=batch-download]").get(0).checked=!1}),$(".media-download").live("click",function(){mediaDownload(this)}),$("#reportUrl-box button").on("click",function(){var e=$("#reportUrl-box"),d=e.find("textarea");try{sentEvent("reportMediaURL_Bot",TabNow.url,d.val())}catch(f){}return e.append('<div id="report-success">The URL report success, we will deal with it as soon as possible, thanks! </div>').addClass("reportUrl_bot_info"),!1}),$("#reportUrl-btn-bot").on("click",function(){$("#reportUrl-box").removeClass("reportUrl_bot_info").show().find("#report-success").remove()}).on("mouseleave",function(){$("#reportUrl-box").hide()})}function sendMessage(e,d,f){chrome.tabs.sendMessage(e,d,function(b){"function"==typeof f&&f(b)})}var ItemFun,dangerItem,mediaTypes,filterTypes,BG,KEY,TabNow,MediaFilted;langSetInit(localStorage.defaultLan),_setIcon("normal"),ItemFun={search:function(d,c){chrome.downloads.search(d,function(b){"function"==typeof c&&c(b)})},getInfo:function(d,c){chrome.downloads.search({id:d},function(b){"function"==typeof c&&c(b[0])})},resume:function(d,c){chrome.downloads.resume(d,function(){"function"==typeof c&&c()})},download:function(d,c){chrome.downloads.download(d,function(b){"function"==typeof c&&c(b)})},erase:function(d,c){chrome.downloads.erase(d,function(b){"function"==typeof c&&c(b)})},cancel:function(d,c){chrome.downloads.cancel(d,function(){"function"==typeof c&&c()})},open:function(b){chrome.downloads.open(b)},show:function(b){chrome.downloads.show(b)},copylink:function(d,c){copyTextToClipboard(d),"function"==typeof c&&c()},removeFile:function(d,c){chrome.downloads.removeFile(d,function(){"function"==typeof c&&c()})},remove:function(d,c){ItemFun.removeFile(d,function(){ItemFun.erase({id:d},function(){"function"==typeof c&&c()})})}},dangerItem={},_checkDanger(),chrome.downloads.onChanged.addListener(function(g){var h,f=g.id,j=$("#"+f),i=g.danger;return i=i?i.current:"",h=i&&"safe"!=i&&"accepted"!=i,!j.size()||h?(pollProgress(),h&&_checkDanger(),void 0):(ItemFun.getInfo(f,function(b){if(!b){return j.remove(),void 0}var c=formatData(b);"download"==c.state&&pollDownloading(),itemRender(f,c)}),void 0)}),medias={},$(function(){init(),$(".button-scan").css("display","true"==localStorage.mediaFinder?"inline-block":"none"),"true"==localStorage.modeMedia&&localStorage.mediaFinder?($("html,body").addClass("mode-media"),mediaShow()):pollProgress(),mediaEventInit(),handleEventBind(),$(".go-downloads").click(function(){openDownloadPage(),sentEvent("popupManagerPage","header-tool","go-downloads")}),$(".go-setting").click(function(){openOptionPage(),sentEvent("popupManagerPage","header-tool","go-setting")}),setTimeout(function(){$.getScript("js/stat.min.js")},400)}),mediaTypes=["video","audio","image"],filterTypes=["video","audio"],BG=chrome.extension.getBackgroundPage(),KEY="B0INXfYFmUVH",TabNow=null,MediaFilted=!1;
